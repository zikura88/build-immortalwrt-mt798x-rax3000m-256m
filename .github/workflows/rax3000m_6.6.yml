# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions

name: Build rax3000m_6.6

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/zikura88/immortalwrt-mt798x-6.6.git
  REPO_BRANCH: openwrt-24.10-6.6
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: rax3000m_6.6_251003.config
  DIY_P1_SH: diy-part1.sh
  DIY_P3_SH: diy-part3.sh
  TZ: Asia/Shanghai
  DEVICE: rax3000m
  UPLOAD_OUTPUT: true
  CLASH_CORE_DIR: openwrt/files/etc/openclash/core

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
    - name: ğŸ” Checkout Repository (patches, config, scripts)
      uses: actions/checkout@main
      with:
        path: repo

    - name: ğŸ–¥ï¸ æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      if: ${{ !cancelled() }}
      run: |
        echo "âš ï¸ è­¦å‘Šï¼šè‹¥æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼Œè¯·åŠæ—¶å–æ¶ˆä»»åŠ¡å¹¶é‡è¯•ï¼"
        echo "âœ… å·²çŸ¥ç¼–è¯‘æˆåŠŸCPUï¼š8370C, 8171M"
        echo "âŒ å·²çŸ¥æ€§èƒ½ä¸è¶³CPUï¼š8272CL, E5ç³»åˆ—"
        echo "-------------------------- CPUä¿¡æ¯ --------------------------"
        echo "ç‰©ç†CPUæ•°é‡: $(cat /proc/cpuinfo | grep 'physical id' | sort | uniq | wc -l)"
        echo "æ ¸å¿ƒ/å‹å·: $(cat /proc/cpuinfo | grep 'core id' | sort | uniq | wc -l) Ã— $(cat /proc/cpuinfo | grep 'model name' | head -1 | cut -d: -f2 | xargs)"
        echo "-------------------------- å†…å­˜ä¿¡æ¯ --------------------------"
        sudo lshw -short -C memory | grep GiB || echo "âŒ æ— æ³•è·å–å†…å­˜ä¿¡æ¯"
        echo "-------------------------- ç¡¬ç›˜ä¿¡æ¯ --------------------------"
        df -Th / /mnt

    - name: ğŸ› ï¸ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get -qq update
        sudo apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404) jq file --no-install-recommends
        sudo apt-get -qq autoremove --purge
        sudo apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /mnt/workdir
        sudo chown $USER:$USER /mnt/workdir

    - name: ğŸ“¦ å…‹éš† OpenWrt æºç 
      working-directory: /mnt/workdir
      run: |
        git clone "$REPO_URL" -b "$REPO_BRANCH" openwrt
        ln -sf /mnt/workdir/openwrt "$GITHUB_WORKSPACE/openwrt"
        echo "âœ… OpenWrt æºç å·²å…‹éš†è‡³ /mnt/workdir/openwrt"

    - name: ğŸ“‚ åŠ è½½è‡ªå®šä¹‰é…ç½®ä¸æ–‡ä»¶
      run: |
        cd openwrt || { echo "âŒ è¿›å…¥ openwrt ç›®å½•å¤±è´¥"; exit 1; }

        # å¤åˆ¶ feeds.conf
        if [ -e "../repo/$FEEDS_CONF" ]; then
          mv "../repo/$FEEDS_CONF" feeds.conf.default
          echo "âœ… feeds.conf å·²åŠ è½½"
        fi

        [ -e repo/files ] && mv repo/files openwrt/files
        [ -e repo/$CONFIG_FILE ] && mv repo/$CONFIG_FILE openwrt/.config

        # èµ‹äºˆè„šæœ¬å¯æ‰§è¡Œæƒé™
        [ -e "../repo/$DIY_P1_SH" ] && chmod +x "../repo/$DIY_P1_SH" && echo "âœ… diy-part1.sh å¯æ‰§è¡Œæƒé™å·²æ·»åŠ "
        [ -e "../repo/$DIY_P3_SH" ] && chmod +x "../repo/$DIY_P3_SH" && echo "âœ… diy-part3.sh å¯æ‰§è¡Œæƒé™å·²æ·»åŠ "

    - name: ğŸ§© æ‰§è¡Œ DIY-P1 è„šæœ¬
      run: |
        cd openwrt
        if [ -e "../repo/$DIY_P1_SH" ]; then
          ../repo/$DIY_P1_SH
          echo "âœ… diy-part1.sh æ‰§è¡Œå®Œæˆ"
        else
          echo "âš ï¸ diy-part1.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi

    - name: ğŸ”„ æ›´æ–° Feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: ğŸ“¦ å®‰è£… Feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: ğŸ› ï¸ æ‰§è¡Œ DIY-P3 è„šæœ¬
      run: |
        cd openwrt
        if [ -e "../repo/$DIY_P3_SH" ]; then
          ../repo/$DIY_P3_SH
          echo "âœ… diy-part3.sh æ‰§è¡Œå®Œæˆ"
        else
          echo "âš ï¸ diy-part3.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi

    - name: ğŸ§± æ›¿æ¢ libxcrypt Makefile
      run: |
        cp repo/custom-files/libxcrypt-Makefile openwrt/feeds/packages/libs/libxcrypt/Makefile
        echo "âœ… Custom libxcrypt Makefile å·²åº”ç”¨"
        ls -l openwrt/feeds/packages/libs/libxcrypt/Makefile

    - name: ğŸ“¥ è‡ªåŠ¨æ£€æµ‹å¹¶ä¸‹è½½ Mihomo å†…æ ¸ (arm64)
      run: |
        MIHOMO_REPO="MetaCubeX/mihomo"
        RELEASE_TAG="Prerelease-Alpha"
        CORE_DIR="openwrt/files/etc/openclash/core"
        TIMEOUT=30

        ROOT_DIR=$(pwd)
        FULL_CORE_DIR="$ROOT_DIR/$CORE_DIR"
        FULL_TARGET_FILE="$FULL_CORE_DIR/clash_meta"

        echo "ğŸ”§ å‡†å¤‡å®‰è£… Mihomo å†…æ ¸..."

        # æ£€æŸ¥ .config
        if [ ! -f "openwrt/.config" ]; then
          echo "âŒ é”™è¯¯ï¼šopenwrt/.config ä¸å­˜åœ¨ï¼"
          exit 1
        fi

        # æ£€æµ‹æ¶æ„
        TARGET_ARCH=$(grep CONFIG_TARGET_ARCH openwrt/.config | cut -d= -f2 | tr -d '"')
        echo "ğŸ“Œ åŸå§‹æ¶æ„: $TARGET_ARCH"

        if [[ "$TARGET_ARCH" == aarch64* ]]; then
          COMMON_ARCH="aarch64"
        elif [[ "$TARGET_ARCH" == arm* ]]; then
          COMMON_ARCH="arm"
        else
          COMMON_ARCH="$TARGET_ARCH"
        fi
        echo "ğŸ”„ é€šç”¨æ¶æ„: $COMMON_ARCH"

        case "$COMMON_ARCH" in
          "aarch64") MIHOMO_ARCH="arm64" ;;
          *) echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $COMMON_ARCH"; exit 1 ;;
        esac
        echo "âœ… æ˜ å°„ä¸º Mihomo æ¶æ„: $MIHOMO_ARCH"

        # è·å–ä¸‹è½½é“¾æ¥
        echo "ğŸŒ è·å– GitHub Release ä¿¡æ¯..."
        ASSET_URL=$(curl -s --fail "https://api.github.com/repos/$MIHOMO_REPO/releases/tags/$RELEASE_TAG" | \
          jq -r '.assets[].browser_download_url' | \
          grep -i "linux-$MIHOMO_ARCH" | \
          grep -i "alpha" | \
          grep -i "\.gz$" | \
          head -n1)

        if [ -z "$ASSET_URL" ]; then
          echo "âŒ æœªæ‰¾åˆ° mihomo-linux-$MIHOMO_ARCH-alpha*.gz æ–‡ä»¶ï¼"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°å†…æ ¸: $ASSET_URL"

        # ä¸‹è½½ã€è§£å‹ã€ç§»åŠ¨
        mkdir -p "$FULL_CORE_DIR"
        wget -O /tmp/mihomo.gz --no-check-certificate --timeout=$TIMEOUT --tries=3 "$ASSET_URL" || { echo "âŒ ä¸‹è½½å¤±è´¥"; exit 1; }
        gunzip /tmp/mihomo.gz || { echo "âŒ è§£å‹å¤±è´¥"; rm -f /tmp/mihomo.gz; exit 1; }
        mv /tmp/mihomo "$FULL_TARGET_FILE" || { echo "âŒ ç§»åŠ¨å¤±è´¥"; exit 1; }
        chmod +x "$FULL_TARGET_FILE"

        # æ ¡éªŒ
        FILE_INFO=$(file "$FULL_TARGET_FILE")
        if echo "$FILE_INFO" | grep -q "aarch64"; then
          echo "âœ… æˆåŠŸï¼æ–‡ä»¶ä¸º aarch64 æ¶æ„ï¼š$FILE_INFO"
        else
          echo "âŒ å¤±è´¥ï¼æ–‡ä»¶ä¸æ˜¯ aarch64 æ¶æ„ï¼š$FILE_INFO"
          rm -f "$FULL_TARGET_FILE"
          exit 1
        fi

        "$FULL_TARGET_FILE" -v || echo "â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯æ— æ³•æ˜¾ç¤º"

        echo "ğŸ‰ Mihomo å†…æ ¸å®‰è£…å®Œæˆï¼"

    - name: ğŸ” SSH è¿æ¥ï¼ˆå¯é€‰ï¼‰
      uses: P3TERX/ssh2actions@v1.0.0
      if: github.event.inputs.ssh == 'true'
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd openwrt
        make defconfig
        make download -j$(nproc)
        echo "ğŸ” æ£€æŸ¥ä¸‹è½½å¤±è´¥çš„åŒ…ï¼ˆ<1KBï¼‰:"
        find dl -size -1024c -exec ls -lh {} \;

    - name: ğŸ”§ ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        make -j$(nproc) V=s
        echo "FILE_DATE=$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

    - name: ğŸ“¤ ä¸Šä¼ è¾“å‡ºæ–‡ä»¶
      uses: actions/upload-artifact@v4
      if: ${{ env.UPLOAD_OUTPUT == 'true' && !cancelled() }}
      with:
        name: ${{ env.DEVICE }}--${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: ğŸ—‚ï¸ æ•´ç†è¾“å‡ºæ–‡ä»¶
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: ğŸ“¦ å‘å¸ƒè‡³ GitHub Release
      uses: ncipollo/release-action@v1
      if: ${{ !cancelled() }}
      with:
        tag: "${{ env.DEVICE }}--${{ env.FILE_DATE }}"
        artifacts: "openwrt/bin/targets/*/*/*"
        body: |
          # âš ï¸ æœªç»æµ‹è¯•
          - è®¾å¤‡: ${{ env.DEVICE }}
          - IP: 192.168.5.1
          - å¯†ç : æ— 
          - å†…æ ¸: Mihomo Prerelease-Alpha (arm64)
